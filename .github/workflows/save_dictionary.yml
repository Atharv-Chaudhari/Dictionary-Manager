name: Save Dictionary Words

on:
  issues:
    types: [opened]

jobs:
  save-dictionary-word:
    # Trigger only for dictionary words
    if: |
      contains(github.event.issue.title, '[DICT]') ||
      contains(github.event.issue.labels.*.name, 'dictionary')
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Check issue details
        run: |
          echo "Issue Title: ${{ github.event.issue.title }}"
          echo "Issue Body Length: ${#{{ github.event.issue.body }}}"
          echo "Labels: ${{ toJSON(github.event.issue.labels.*.name) }}"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Parse dictionary word
        id: parse
        run: |
          # Extract word from title
          WORD=$(echo "${{ github.event.issue.title }}" | sed 's/\[DICT\]\s*//' | xargs)
          FILENAME=$(echo "$WORD" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g')
          
          echo "word=$WORD" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "Extracted word: $WORD"
          echo "Filename: $FILENAME"

      - name: Create dictionaries directory
        run: mkdir -p dictionaries

      - name: Save dictionary word
        run: |
          # Save the issue body (which contains JSON) as a file
          echo "${{ github.event.issue.body }}" > "dictionaries/${{ steps.parse.outputs.filename }}.json"
          
          # Validate JSON
          if python3 -m json.tool "dictionaries/${{ steps.parse.outputs.filename }}.json" > /dev/null 2>&1; then
            echo "âœ… Valid JSON saved"
          else
            echo "âš ï¸ Invalid JSON, saving as text"
            # If not valid JSON, wrap it as JSON
            echo "{\"word\": \"${{ steps.parse.outputs.word }}\", \"content\": ${{ toJSON(github.event.issue.body) }}}" > "dictionaries/${{ steps.parse.outputs.filename }}.json"
          fi

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dictionaries/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“š Add dictionary word: ${{ steps.parse.outputs.word }}"
            git push
          fi

      - name: Close issue and comment
        uses: actions/github-script@v7
        with:
          script: |
            const word = '${{ steps.parse.outputs.word }}';
            const filename = '${{ steps.parse.outputs.filename }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… Dictionary word "${word}" saved successfully!\n\n**File saved:** dictionaries/${filename}.json\n**View:** https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/dictionaries/${filename}.json\n\nThis word is now stored in your dictionary repository.`
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              labels: ['dictionary', 'saved', 'auto-saved']
            });

  update-main-dictionary:
    needs: save-dictionary-word
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Combine all dictionary files
        run: |
          # Combine all JSON files into one master dictionary
          echo '{"words": [' > combined_dictionary.json
          
          # Find all JSON files in dictionaries folder
          find dictionaries -name "*.json" | while read file; do
            cat "$file"
            echo ","
          done | sed '$ s/,$//' >> combined_dictionary.json
          
          echo ']}' >> combined_dictionary.json
          
          # Validate combined JSON
          python3 -m json.tool combined_dictionary.json > dictionary.json
          
          # Move to docs folder
          mkdir -p docs
          mv dictionary.json docs/dictionary.json

      - name: Commit combined dictionary
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/dictionary.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“š Update combined dictionary"
            git push
          fi
