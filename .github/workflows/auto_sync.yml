name: ðŸ¤– Auto Sync Dictionary

on:
  # Run every 5 minutes
  schedule:
    - cron: '*/5 * * * *'
  
  # Run on repository dispatch (from web app)
  repository_dispatch:
    types: [dictionary_update]
  
  # Run on push (when we update the file)
  push:
    paths:
      - 'dictionary.json'
  
  # Manual trigger
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup environment
        run: |
          # Create directories
          mkdir -p data
          mkdir -p backup
          
          # Install jq for JSON processing
          sudo apt-get update
          sudo apt-get install -y jq
      
      - name: Process changes from web app
        id: process_changes
        run: |
          echo "ðŸ” Looking for changes from web app..."
          
          # Check if there are pending changes from localStorage
          # (In real app, this would come from an API or webhook)
          
          # For now, we'll process the current dictionary.json
          if [ -f "dictionary.json" ]; then
            echo "ðŸ“š Found existing dictionary"
            WORD_COUNT=$(jq '.words | length' dictionary.json)
            echo "word_count=$WORD_COUNT" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“ Creating initial dictionary"
            echo '{"words": [], "metadata": {"created": "'$(date -Iseconds)'", "version": "1.0", "totalWords": 0}}' > dictionary.json
            echo "word_count=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Merge external changes
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "ðŸ”„ Merging external changes..."
          
          # This is where you would merge changes from web app
          # For now, we'll just update the timestamp
          jq '.metadata.lastSync = "'$(date -Iseconds)'"' dictionary.json > temp.json
          mv temp.json dictionary.json
      
      - name: Create data files
        run: |
          echo "ðŸ“ Creating data files..."
          
          # Create individual word files
          jq -c '.words[]' dictionary.json | while read word; do
            WORD_NAME=$(echo "$word" | jq -r '.word' | tr ' ' '_' | tr '[:upper:]' '[:lower:]')
            echo "$word" | jq '.' > "data/${WORD_NAME}.json"
          done
          
          # Create web-accessible version
          cat > dictionary-data.js << 'EOF'
          // Auto-generated dictionary data
          // Last sync: $(date)
          window.dictionaryData = $(cat dictionary.json);
          console.log('ðŸ“š Dictionary loaded:', window.dictionaryData.words.length, 'words');
          if (window.dictionary && window.dictionary.loadData) {
            window.dictionary.loadData(window.dictionaryData);
          }
          EOF
      
      - name: Create backup
        run: |
          echo "ðŸ’¾ Creating backup..."
          cp dictionary.json "backup/dictionary_$(date +%Y%m%d_%H%M%S).json"
          
          # Keep only last 10 backups
          ls -1 backup/dictionary_*.json | head -n -10 | xargs -r rm
      
      - name: Commit and push changes
        run: |
          echo "ðŸš€ Committing changes..."
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add dictionary.json dictionary-data.js data/ backup/
          
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit"
          else
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            WORD_COUNT=$(jq '.words | length' dictionary.json)
            git commit -m "ðŸ¤– Auto-sync: ${TIMESTAMP} (${WORD_COUNT} words)"
            git push
            echo "âœ… Changes pushed to GitHub"
          fi
      
      - name: Update sync status
        run: |
          echo "ðŸ”„ Sync completed at $(date)"
          echo "ðŸ“Š Word count: $(jq '.words | length' dictionary.json)"