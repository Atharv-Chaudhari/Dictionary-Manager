name: ðŸ¤– Auto Sync Dictionary

on:
  # Run every hour
  schedule:
    - cron: '0 * * * *'
  
  # Run when issues are created
  issues:
    types: [opened]
  
  # Manual trigger
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          npm install -g jq
      
      - name: Process dictionary data
        run: |
          echo "ðŸ” Processing dictionary data..."
          
          # Create directories
          mkdir -p data
          
          # Check if this was triggered by an issue
          if [ "${{ github.event_name }}" = "issues" ]; then
            echo "ðŸ“ Processing issue #${{ github.event.issue.number }}"
            
            # Extract JSON from issue body
            ISSUE_BODY="${{ github.event.issue.body }}"
            
            # Try to find JSON in code block
            if echo "$ISSUE_BODY" | grep -q '```json'; then
              # Extract JSON data
              JSON_DATA=$(echo "$ISSUE_BODY" | sed -n '/```json/,/```/p' | sed '1d;$d')
              
              if [ -n "$JSON_DATA" ]; then
                echo "$JSON_DATA" > data/latest_sync.json
                echo "âœ… Extracted JSON data from issue"
                
                # Save individual words
                echo "$JSON_DATA" | jq -r '.words[] | @base64' | while read word; do
                  WORD_JSON=$(echo "$word" | base64 --decode)
                  WORD_NAME=$(echo "$WORD_JSON" | jq -r '.word' | tr ' ' '_' | tr '[:upper:]' '[:lower:]')
                  
                  echo "$WORD_JSON" > "data/${WORD_NAME}.json"
                  echo "ðŸ’¾ Saved: $WORD_NAME"
                done
              fi
            fi
          fi
          
          # Create combined dictionary.json
          echo '{"words": [], "lastSync": "'$(date -Iseconds)'", "totalWords": 0}' > dictionary.json
          
          # Add all word files
          for file in data/*.json; do
            if [ -f "$file" ]; then
              jq '.words += [input]' dictionary.json "$file" > temp.json
              mv temp.json dictionary.json
            fi
          done
          
          # Update metadata
          WORD_COUNT=$(jq '.words | length' dictionary.json)
          jq ".totalWords = $WORD_COUNT | .metadata = {lastSync: \"$(date -Iseconds)\", totalWords: $WORD_COUNT, version: \"2.0\"}" dictionary.json > temp.json
          mv temp.json dictionary.json
          
          echo "ðŸ“Š Total words: $WORD_COUNT"
      
      - name: Create web-accessible data
        run: |
          # Create a JS file for web access
          cat > dictionary-data.js << 'EOF'
          // Auto-generated dictionary data
          // Last sync: $(date)
          const dictionaryData = $(cat dictionary.json);
          
          // Make it globally available
          if (typeof window !== 'undefined') {
            window.dictionaryData = dictionaryData;
            
            // Auto-update if dictionary manager exists
            if (window.dictionary && window.dictionary.loadData) {
              window.dictionary.loadData(dictionaryData);
            }
          }
          
          console.log('ðŸ“š Dictionary loaded:', dictionaryData.totalWords, 'words');
          EOF
      
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add dictionary.json dictionary-data.js data/
          
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit"
          else
            git commit -m "ðŸ¤– Auto-sync: $(date '+%Y-%m-%d %H:%M')"
            git push
          fi
      
      - name: Close issue if created
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const wordCount = require('fs').readFileSync('dictionary.json', 'utf8');
            const data = JSON.parse(wordCount);
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… Dictionary synced successfully!\n\n**Total words:** ${data.totalWords}\n**View data:** https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/main/dictionary.json\n\n*This issue was automatically closed by the sync workflow.*`
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });