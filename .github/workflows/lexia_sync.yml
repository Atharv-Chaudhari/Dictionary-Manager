name: ðŸš€ LexiAI Sync

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:
  issues:
    types: [opened]

jobs:
  sync-dictionary:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Process LexiAI Data
        id: process
        run: |
          echo "ðŸ”„ Processing LexiAI sync..."
          
          # Create directories
          mkdir -p dictionaries lexiai_data
          
          # Process issues
          if [ "${{ github.event_name }}" = "issues" ]; then
            echo "ðŸ“ Processing new issue..."
            
            # Extract data from issue body
            ISSUE_BODY="${{ github.event.issue.body }}"
            
            # Try to extract JSON from code block
            if echo "$ISSUE_BODY" | grep -q '```json'; then
              JSON_DATA=$(echo "$ISSUE_BODY" | sed -n '/```json/,/```/p' | sed '1d;$d')
              
              if [ -n "$JSON_DATA" ]; then
                echo "$JSON_DATA" > lexiai_data/latest_sync.json
                
                # Extract words
                echo "$JSON_DATA" | jq -r '.words[] | @base64' | while read word; do
                  WORD_DATA=$(echo "$word" | base64 --decode)
                  WORD_NAME=$(echo "$WORD_DATA" | jq -r '.word' | tr ' ' '_' | tr '[:upper:]' '[:lower:]')
                  
                  echo "$WORD_DATA" > "dictionaries/${WORD_NAME}.json"
                  echo "âœ… Saved: ${WORD_NAME}.json"
                done
              fi
            fi
          fi
          
          # Combine all dictionary files
          echo '{"words": [], "metadata": {"lastSync": "'$(date -Iseconds)'", "source": "LexiAI"}}' > combined.json
          
          # Add all word files
          for file in dictionaries/*.json; do
            if [ -f "$file" ]; then
              jq '.words += [input]' combined.json "$file" > temp.json
              mv temp.json combined.json
            fi
          done
          
          # Create the main dictionary file
          TOTAL_WORDS=$(jq '.words | length' combined.json)
          jq ".metadata.totalWords = $TOTAL_WORDS | .metadata.version = \"2.0\"" combined.json > dictionary.json
          
          echo "words=$TOTAL_WORDS" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Total words: $TOTAL_WORDS"
      
      - name: Update GitHub Pages Data
        run: |
          # Create JavaScript file for web access
          cat > dictionary.js << 'EOF'
          // Auto-generated by LexiAI
          // Last sync: $(date)
          window.lexiaiData = $(cat dictionary.json);
          
          // Make it available globally
          if (typeof window.lexiai !== 'undefined') {
            window.lexiai.loadFromData(window.lexiaiData);
          }
          
          console.log('ðŸ“š LexiAI dictionary loaded:', window.lexiaiData.metadata.totalWords, 'words');
          EOF
          
          # Also create a pretty HTML view
          cat > dictionary-view.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>LexiAI Dictionary</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .word { border: 1px solid #ddd; padding: 20px; margin: 10px 0; border-radius: 8px; }
                  .word h3 { color: #4f46e5; margin-top: 0; }
              </style>
          </head>
          <body>
              <h1>ðŸ“š LexiAI Dictionary</h1>
              <p>Total words: $TOTAL_WORDS | Last sync: $(date)</p>
              <div id="words"></div>
              
              <script>
                  fetch('dictionary.json')
                      .then(r => r.json())
                      .then(data => {
                          const container = document.getElementById('words');
                          data.words.forEach(word => {
                              const div = document.createElement('div');
                              div.className = 'word';
                              div.innerHTML = `
                                  <h3>${word.word}</h3>
                                  <p><em>${word.partOfSpeech}</em> â€¢ ${word.pronunciation}</p>
                                  <p>${word.definition}</p>
                                  ${word.examples ? `<p><strong>Examples:</strong><br>${word.examples.map(e => `â€¢ ${e}`).join('<br>')}</p>` : ''}
                              `;
                              container.appendChild(div);
                          });
                      });
              </script>
          </body>
          </html>
          EOF
      
      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add dictionary.json dictionary.js dictionary-view.html dictionaries/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– LexiAI Sync: ${{ steps.process.outputs.words }} words"
            git push
          fi
      
      - name: Close Issue if Created
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… LexiAI sync complete! ${{ steps.process.outputs.words }} words processed.\n\n**View dictionary:** https://${context.repo.owner}.github.io/${context.repo.repo}/dictionary-view.html\n**Download JSON:** https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/main/dictionary.json`
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

  deploy-pages:
    needs: sync-dictionary
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
