<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“š AI Dictionary Manager</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Puter.js -->
    <script src="https://js.puter.com/v2/"></script>
    
    <!-- Our Styles -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Main App -->
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-brain"></i>
                <div>
                    <h1>AI Dictionary</h1>
                    <p>Smart vocabulary manager</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="btn btn-primary" id="syncBtn">
                    <i class="fas fa-sync-alt"></i> Sync
                </button>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- AI Assistant -->
                <div class="ai-assistant">
                    <h3><i class="fas fa-robot"></i> AI Assistant</h3>
                    <div class="ai-input">
                        <input type="text" id="aiWordInput" placeholder="Enter a word...">
                        <button class="btn btn-primary" id="aiAnalyzeBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="ai-result" id="aiResult">
                        <!-- AI results will appear here -->
                    </div>
                </div>

                <!-- Stats -->
                <div class="stats">
                    <div class="stat-card">
                        <i class="fas fa-font"></i>
                        <div>
                            <h3 id="totalWords">0</h3>
                            <p>Total Words</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-star"></i>
                        <div>
                            <h3 id="masteredWords">0</h3>
                            <p>Mastered</p>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filters">
                    <button class="filter-btn active" data-filter="all">All Words</button>
                    <button class="filter-btn" data-filter="learning">Learning</button>
                    <button class="filter-btn" data-filter="mastered">Mastered</button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="content">
                <!-- Search -->
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search words...">
                    <button class="btn btn-primary" id="addWordBtn">
                        <i class="fas fa-plus"></i> Add Word
                    </button>
                </div>

                <!-- Words Grid -->
                <div class="words-grid" id="wordsGrid">
                    <!-- Words will appear here -->
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState">
                    <i class="fas fa-book-open"></i>
                    <h2>No words yet</h2>
                    <p>Use the AI assistant to add your first word!</p>
                    <button class="btn btn-primary" id="tryAI">
                        <i class="fas fa-magic"></i> Try AI Assistant
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Word Detail Modal -->
    <div class="modal" id="wordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Word Details</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Word details will appear here -->
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer"></div>

    <!-- Our JavaScript -->
    <script>
        // Dictionary Manager Class
        class DictionaryManager {
            constructor() {
                this.words = [];
                this.puter = null;
                this.init();
            }

            async init() {
                this.loadWords();
                this.setupUI();
                this.setupPuter();
                this.renderWords();
                this.updateStats();
            }

            async setupPuter() {
                try {
                    this.puter = window.puter;
                    await this.puter.auth.getUser();
                    console.log('âœ… Puter.js connected');
                    this.showToast('AI Assistant ready!', 'success');
                } catch (error) {
                    console.log('âš ï¸ Puter.js not available');
                    this.showToast('Using offline mode', 'info');
                }
            }

            setupUI() {
                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', () => {
                    document.body.classList.toggle('dark-theme');
                });

                // AI analyze
                document.getElementById('aiAnalyzeBtn').addEventListener('click', () => {
                    const word = document.getElementById('aiWordInput').value.trim();
                    if (word) this.analyzeWord(word);
                });

                document.getElementById('aiWordInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const word = e.target.value.trim();
                        if (word) this.analyzeWord(word);
                    }
                });

                // Try AI button
                document.getElementById('tryAI').addEventListener('click', () => {
                    document.getElementById('aiWordInput').focus();
                });

                // Add word button
                document.getElementById('addWordBtn').addEventListener('click', () => {
                    this.showAddWordModal();
                });

                // Sync button
                document.getElementById('syncBtn').addEventListener('click', () => {
                    this.syncToGitHub();
                });

                // Search
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.renderWords(e.target.value);
                });

                // Filters
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.renderWords();
                    });
                });

                // Modal close
                document.querySelector('.close-btn').addEventListener('click', () => {
                    document.getElementById('wordModal').classList.remove('active');
                });

                // Close modal on backdrop click
                document.getElementById('wordModal').addEventListener('click', (e) => {
                    if (e.target.id === 'wordModal') {
                        e.target.classList.remove('active');
                    }
                });
            }

            async analyzeWord(word) {
                if (!this.puter) {
                    this.showToast('Puter.js not available. Add word manually.', 'error');
                    this.showAddWordModal(word);
                    return;
                }

                try {
                    this.showToast(`Analyzing "${word}"...`, 'info');
                    
                    const response = await this.puter.ai.chat({
                        messages: [{
                            role: 'system',
                            content: `You are a dictionary expert. For the word "${word}", provide:
                            {
                                "word": "${word}",
                                "definition": "clear definition",
                                "partOfSpeech": "noun/verb/etc",
                                "pronunciation": "/phonetics/",
                                "examples": ["example 1", "example 2", "example 3"],
                                "synonyms": ["syn1", "syn2", "syn3"],
                                "antonyms": ["ant1", "ant2"],
                                "difficulty": "easy/medium/difficult"
                            }`
                        }],
                        model: 'gpt-3.5-turbo'
                    });

                    const aiText = response.choices[0].message.content;
                    const jsonMatch = aiText.match(/\{[\s\S]*\}/);
                    
                    if (jsonMatch) {
                        const wordData = JSON.parse(jsonMatch[0]);
                        this.showAIResult(wordData);
                    } else {
                        throw new Error('No JSON found');
                    }

                } catch (error) {
                    console.error('AI error:', error);
                    this.showToast('AI analysis failed. Add manually.', 'error');
                    this.showAddWordModal(word);
                }
            }

            showAIResult(wordData) {
                const resultDiv = document.getElementById('aiResult');
                
                resultDiv.innerHTML = `
                    <div class="ai-word-result">
                        <h4>${wordData.word} <small>(${wordData.partOfSpeech})</small></h4>
                        <p><strong>Definition:</strong> ${wordData.definition}</p>
                        <p><strong>Pronunciation:</strong> ${wordData.pronunciation}</p>
                        
                        <div class="ai-actions">
                            <button class="btn btn-success" id="saveAIWord">
                                <i class="fas fa-save"></i> Save to Dictionary
                            </button>
                            <button class="btn" id="editAIWord">
                                <i class="fas fa-edit"></i> Edit First
                            </button>
                        </div>
                    </div>
                `;

                // Save button
                document.getElementById('saveAIWord').addEventListener('click', () => {
                    this.addWord(wordData);
                    resultDiv.innerHTML = '';
                    document.getElementById('aiWordInput').value = '';
                });

                // Edit button
                document.getElementById('editAIWord').addEventListener('click', () => {
                    this.showAddWordModal(wordData.word, wordData);
                    resultDiv.innerHTML = '';
                });
            }

            showAddWordModal(word = '', data = null) {
                document.getElementById('modalTitle').textContent = data ? 'Edit Word' : 'Add New Word';
                
                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = `
                    <form id="wordForm">
                        <div class="form-group">
                            <label>Word *</label>
                            <input type="text" id="formWord" value="${word}" required>
                        </div>
                        <div class="form-group">
                            <label>Definition *</label>
                            <textarea id="formDefinition" rows="3" required>${data?.definition || ''}</textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Part of Speech</label>
                                <select id="formPartOfSpeech">
                                    <option ${data?.partOfSpeech === 'noun' ? 'selected' : ''}>noun</option>
                                    <option ${data?.partOfSpeech === 'verb' ? 'selected' : ''}>verb</option>
                                    <option ${data?.partOfSpeech === 'adjective' ? 'selected' : ''}>adjective</option>
                                    <option ${data?.partOfSpeech === 'adverb' ? 'selected' : ''}>adverb</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Difficulty</label>
                                <select id="formDifficulty">
                                    <option ${data?.difficulty === 'easy' ? 'selected' : ''}>easy</option>
                                    <option ${data?.difficulty === 'medium' || !data ? 'selected' : ''}>medium</option>
                                    <option ${data?.difficulty === 'difficult' ? 'selected' : ''}>difficult</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn" id="cancelForm">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Word</button>
                        </div>
                    </form>
                `;

                // Form submission
                const form = document.getElementById('wordForm');
                form.onsubmit = (e) => {
                    e.preventDefault();
                    this.saveWordFromForm();
                };

                // Cancel button
                document.getElementById('cancelForm').addEventListener('click', () => {
                    document.getElementById('wordModal').classList.remove('active');
                });

                // Show modal
                document.getElementById('wordModal').classList.add('active');
                document.getElementById('formWord').focus();
            }

            saveWordFromForm() {
                const wordData = {
                    word: document.getElementById('formWord').value.trim(),
                    definition: document.getElementById('formDefinition').value.trim(),
                    partOfSpeech: document.getElementById('formPartOfSpeech').value,
                    difficulty: document.getElementById('formDifficulty').value,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    mastered: false
                };

                this.addWord(wordData);
                document.getElementById('wordModal').classList.remove('active');
            }

            addWord(wordData) {
                const word = {
                    id: Date.now(),
                    ...wordData,
                    examples: wordData.examples || [],
                    synonyms: wordData.synonyms || [],
                    antonyms: wordData.antonyms || [],
                    pronunciation: wordData.pronunciation || '',
                    source: wordData.source || 'Manual'
                };

                this.words.push(word);
                this.saveWords();
                this.renderWords();
                this.updateStats();
                
                this.showToast(`"${word.word}" added successfully!`, 'success');
                return word;
            }

            loadWords() {
                try {
                    const saved = localStorage.getItem('dictionary_words');
                    this.words = saved ? JSON.parse(saved) : [];
                    
                    // Add sample if empty
                    if (this.words.length === 0) {
                        this.words = [{
                            id: 1,
                            word: 'Serendipity',
                            definition: 'The occurrence of events by chance in a happy way',
                            partOfSpeech: 'noun',
                            pronunciation: '/ËŒserÉ™nËˆdÉªpÉ™ti/',
                            difficulty: 'medium',
                            mastered: false,
                            createdAt: new Date().toISOString()
                        }];
                        this.saveWords();
                    }
                } catch (error) {
                    this.words = [];
                }
            }

            saveWords() {
                localStorage.setItem('dictionary_words', JSON.stringify(this.words));
            }

            renderWords(search = '') {
                const grid = document.getElementById('wordsGrid');
                const emptyState = document.getElementById('emptyState');
                const filter = document.querySelector('.filter-btn.active').dataset.filter;
                
                // Filter words
                let filtered = this.words.filter(word => {
                    if (search && !word.word.toLowerCase().includes(search.toLowerCase()) && 
                        !word.definition.toLowerCase().includes(search.toLowerCase())) {
                        return false;
                    }
                    
                    if (filter === 'learning' && word.mastered) return false;
                    if (filter === 'mastered' && !word.mastered) return false;
                    
                    return true;
                });

                // Sort alphabetically
                filtered.sort((a, b) => a.word.localeCompare(b.word));

                // Show/hide empty state
                if (filtered.length === 0) {
                    grid.innerHTML = '';
                    emptyState.style.display = 'flex';
                    return;
                }

                emptyState.style.display = 'none';

                // Render words
                grid.innerHTML = filtered.map(word => `
                    <div class="word-card" data-id="${word.id}">
                        <div class="word-header">
                            <h3>${word.word}</h3>
                            <span class="word-badge ${word.difficulty}">${word.difficulty}</span>
                        </div>
                        <p class="word-definition">${word.definition}</p>
                        <div class="word-footer">
                            <span class="word-tag">${word.partOfSpeech}</span>
                            <div class="word-actions">
                                <button class="icon-btn" onclick="dictionary.toggleMastered(${word.id})" title="${word.mastered ? 'Unmark mastered' : 'Mark mastered'}">
                                    <i class="fas ${word.mastered ? 'fa-star' : 'fa-star'}"></i>
                                </button>
                                <button class="icon-btn" onclick="dictionary.deleteWord(${word.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Add click event to view word
                document.querySelectorAll('.word-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (!e.target.closest('.word-actions')) {
                            const id = parseInt(card.dataset.id);
                            this.viewWord(id);
                        }
                    });
                });
            }

            viewWord(id) {
                const word = this.words.find(w => w.id === id);
                if (!word) return;

                document.getElementById('modalTitle').textContent = word.word;
                
                document.getElementById('modalBody').innerHTML = `
                    <div class="word-detail">
                        <div class="word-meta">
                            <span class="tag">${word.partOfSpeech}</span>
                            <span class="tag ${word.difficulty}">${word.difficulty}</span>
                            <span class="tag ${word.mastered ? 'mastered' : ''}">
                                ${word.mastered ? 'Mastered' : 'Learning'}
                            </span>
                        </div>
                        
                        <div class="definition">
                            <h4>Definition</h4>
                            <p>${word.definition}</p>
                        </div>
                        
                        ${word.pronunciation ? `
                        <div class="pronunciation">
                            <h4>Pronunciation</h4>
                            <p>${word.pronunciation}</p>
                        </div>` : ''}
                        
                        ${word.examples?.length > 0 ? `
                        <div class="examples">
                            <h4>Examples</h4>
                            <ul>${word.examples.map(ex => `<li>${ex}</li>`).join('')}</ul>
                        </div>` : ''}
                        
                        ${word.synonyms?.length > 0 ? `
                        <div class="synonyms">
                            <h4>Synonyms</h4>
                            <div class="tags">${word.synonyms.map(s => `<span class="tag">${s}</span>`).join('')}</div>
                        </div>` : ''}
                        
                        <div class="detail-actions">
                            <button class="btn" onclick="dictionary.toggleMastered(${word.id})">
                                <i class="fas fa-star"></i> ${word.mastered ? 'Unmark Mastered' : 'Mark as Mastered'}
                            </button>
                            <button class="btn btn-danger" onclick="dictionary.deleteWord(${word.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('wordModal').classList.add('active');
            }

            toggleMastered(id) {
                const word = this.words.find(w => w.id === id);
                if (word) {
                    word.mastered = !word.mastered;
                    word.updatedAt = new Date().toISOString();
                    this.saveWords();
                    this.renderWords();
                    this.updateStats();
                    
                    this.showToast(
                        `"${word.word}" ${word.mastered ? 'marked as mastered!' : 'unmarked from mastered'}`,
                        'success'
                    );
                }
            }

            deleteWord(id) {
                const word = this.words.find(w => w.id === id);
                if (!word) return;

                if (confirm(`Delete "${word.word}"?`)) {
                    this.words = this.words.filter(w => w.id !== id);
                    this.saveWords();
                    this.renderWords();
                    this.updateStats();
                    
                    this.showToast(`"${word.word}" deleted`, 'success');
                    document.getElementById('wordModal').classList.remove('active');
                }
            }

            updateStats() {
                document.getElementById('totalWords').textContent = this.words.length;
                
                const mastered = this.words.filter(w => w.mastered).length;
                document.getElementById('masteredWords').textContent = mastered;
            }

            async syncToGitHub() {
                try {
                    this.showToast('Syncing to GitHub...', 'info');
                    
                    const data = {
                        words: this.words,
                        lastSync: new Date().toISOString(),
                        totalWords: this.words.length
                    };

                    // Create GitHub issue URL
                    const issueUrl = `https://github.com/Atharv-Chaudhari/Dictionary-Manager/issues/new?` +
                        `title=[DICT-SYNC] ${new Date().toLocaleDateString()}&` +
                        `body=\`\`\`json\n${JSON.stringify(data, null, 2)}\n\`\`\`&` +
                        `labels=dictionary,sync`;

                    // Open in new tab
                    window.open(issueUrl, '_blank');
                    
                    this.showToast('GitHub sync initiated!', 'success');
                    
                } catch (error) {
                    this.showToast('Sync failed: ' + error.message, 'error');
                }
            }

            showToast(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    info: 'fas fa-info-circle'
                };
                
                toast.innerHTML = `
                    <i class="${icons[type]}"></i>
                    <span>${message}</span>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        }

        // Initialize the app
        window.dictionary = new DictionaryManager();
    </script>
</body>
</html>